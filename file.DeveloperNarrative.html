<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>File: DeveloperNarrative</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html" title="Index">Index</a> &raquo; 
    <span class="title">File: DeveloperNarrative</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><div id='filecontents'><h1>A Narrative for Developers</h1>

<p>This document explores the <code>OnStomp</code> library through a narrative aimed at end
developers who wish to extend or modify the library.  It will start with the
basics and work through the important code through exposition and examples.
It may be helpful to
review the <a href="http://stomp.github.com/index.html">STOMP specification</a> before
diving into this document. It's also important to note that <code>onstomp</code> can
only be used with Ruby 1.8.7+.  Support for Rubies prior to 1.8.7 does not
exist, and even requiring the library in your code will probably generate
errors.</p>

<h2>Clients &amp; Frames</h2>

<p>An instance of <span class='object_link'><a href="OnStomp/Client.html" title="OnStomp::Client (class)">OnStomp::Client</a></span> is the primary way a user will interact
with the <code>OnStomp</code> gem. It provides the helper methods to generate STOMP
frames by including the <span class='object_link'><a href="OnStomp/Interfaces/FrameMethods.html" title="OnStomp::Interfaces::FrameMethods (module)">OnStomp::Interfaces::FrameMethods</a></span> mixin, and allows
binding event callbacks by including <span class='object_link'><a href="OnStomp/Interfaces/ClientEvents.html" title="OnStomp::Interfaces::ClientEvents (module)">OnStomp::Interfaces::ClientEvents</a></span>
(which in turn includes <span class='object_link'><a href="OnStomp/Interfaces/EventManager.html" title="OnStomp::Interfaces::EventManager (module)">OnStomp::Interfaces::EventManager</a></span>.) Every client
instance will provide the same frame methods, regardless of the version of
the STOMP protocol being used. This is accomplished through by a client's use
of <span class='object_link'><a href="OnStomp/Connections.html" title="OnStomp::Connections (module)">connections</a></span> and
<span class='object_link'><a href="OnStomp/Connections/Serializers.html" title="OnStomp::Connections::Serializers (module)">serializers</a></span> to actually generate the
frames and convert them to their appropriate string representation. You can
read more about these components in a later section.</p>

<p>All of the frame methods (eg: <span class='object_link'><a href="OnStomp/Interfaces/FrameMethods.html#send-instance_method" title="OnStomp::Interfaces::FrameMethods#send (method)">send</a></span>,
<span class='object_link'><a href="OnStomp/Interfaces/FrameMethods.html#send-instance_method" title="OnStomp::Interfaces::FrameMethods#send (method)">unsubscribe</a></span>) will either generate a
new <span class='object_link'><a href="OnStomp/Components/Frame.html" title="OnStomp::Components::Frame (class)">OnStomp::Components::Frame</a></span> instance or raise an error if the STOMP
protocol version negotiated between broker and client does not support
the requested command (eg: STOMP 1.0 does not support NACK frames.)  All
frame instances are composed of a <span class='object_link'><a href="OnStomp/Components/Frame.html#command-instance_method" title="OnStomp::Components::Frame#command (method)">command</a></span>,
a set of <span class='object_link'><a href="OnStomp/Components/Frame.html#headers-instance_method" title="OnStomp::Components::Frame#headers (method)">headers</a></span>, and a
<span class='object_link'><a href="OnStomp/Components/Frame.html#body-instance_method" title="OnStomp::Components::Frame#body (method)">body</a></span>.</p>

<p>A frame's <span class='object_link'><a href="OnStomp/Components/Frame.html#command-instance_method" title="OnStomp::Components::Frame#command (method)">command</a></span> attribute is a string
that matches the corresponding STOMP command (eg: SEND, RECEIPT) with one
exception: heart-beats. The STOMP 1.1 protocol supports "heart-beating" to
let brokers and clients know that the connection is still active on the other
end by sending bare line-feed (ie: <code>\n</code>) characters between frame exchanges.
As a result, calling <span class='object_link'><a href="OnStomp/Interfaces/FrameMethods.html#beat-instance_method" title="OnStomp::Interfaces::FrameMethods#beat (method)">beat</a></span> on a client
will generate a frame whose command attribute is <code>nil</code>. This in turn lets the
serializer know that this isn't a true frame and it will convert it to
+"\n"+ instead of performing the normal serialization operation.</p>

<p>A frame's <span class='object_link'><a href="OnStomp/Components/FrameHeaders.html" title="OnStomp::Components::FrameHeaders (class)">headers</a></span> behave much like a
standard Ruby <code>Hash</code> but with a few important differences. First, the order
that header names were added is preserved. This is also true of Ruby 1.9+
hashes but not those of Ruby 1.8.7, and as a result there is some code
to maintain the ordering when running 1.8.7. Second, accessing headers
is somewhat indifferent:</p>

<pre class="code"><span class='id frame'>frame</span><span class='lbracket'>[</span><span class='symbol'>:some_header</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>a value</span><span class='tstring_end'>'</span></span>
<span class='id frame'>frame</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>some_header</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='comment'>#=&gt; 'a value'
</span></pre>

<p>What actually happens is all header names are converted to <code>Symbol</code>s
(by calling <code>obj.to_sym</code>) before any setting or getting takes place. Using
an object as a header name that does not respond to <code>to_sym</code> will raise an
error. The final major difference between headers and hashes is that header
values are only strings:</p>

<pre class="code"><span class='id frame'>frame</span><span class='lbracket'>[</span><span class='symbol'>:another_header</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>42</span>
<span class='id frame'>frame</span><span class='lbracket'>[</span><span class='symbol'>:another_header</span><span class='rbracket'>]</span> <span class='comment'>#=&gt; '42'
</span></pre>

<p>If the object passed as a header value cannot be converted to a string an
error will be raised.</p>

<p>For most kinds of frames, the <span class='object_link'><a href="OnStomp/Components/Frame.html#body-instance_method" title="OnStomp::Components::Frame#body (method)">body</a></span> attribute
will often be an empty string or <code>nil</code>. The only frames that support
non-empty bodies are SEND, MESSAGE, and ERROR.</p>

<h2>Events</h2>

<h3>Frame-centric Events</h3>

<p>Event triggering sequence for client generated frames:</p>

<ol>
<li><code>client.send ...</code> is invoked and a SEND frame is created</li>
<li>The event <code>before_transmitting</code> is triggered for the SEND frame</li>
<li>The event <code>before_send</code> is triggered for the SEND frame</li>
<li>The SEND frame is added to the <span class='object_link'><a href="OnStomp/Connections/Base.html" title="OnStomp::Connections::Base (class)">connection</a></span>'s
write buffer</li>
<li>Some amount of time passes</li>
<li>The SEND frame is serialized and fully written to the broker.</li>
<li>The event <code>after_transmitting</code> is triggered for the SEND frame</li>
<li>The event <code>on_send</code> is triggered for the SEND frame</li>
</ol>


<p>Event triggering sequence for broker generated frames:</p>

<ol>
<li>The broker writes a MESSAGE frame to the TCP/IP socket</li>
<li>Some amount of time passes</li>
<li>The client fully reads and de-serializes the MESSAGE frame</li>
<li>The event <code>before_receiving</code> is triggered for the MESSAGE frame</li>
<li>The event <code>before_message</code> is triggered for the MESSAGE frame</li>
<li>The event <code>after_receiving</code> is triggered for the MESSAGE frame</li>
<li>The event <code>on_message</code> is triggered for the MESSAGE frame</li>
</ol>


<h3>Connection-centric Events</h3>

<p>Event trigger sequence for connection events:</p>

<ol>
<li>An IO error occurs while the connection is reading or writing</li>
<li>The connection closes its socket</li>
<li>The connection triggers :on_terminated</li>
<li>The connection triggers :on_closed</li>
</ol>


<h2>Subscription and Receipt Management</h2>

<h3>Subscription Manager</h3>

<h3>Receipt Manager</h3>

<h2>URI Based Configuration</h2>

<h2>Processors</h2>

<h2>Connections &amp; Serializers</h2>

<h3>Connections</h3>

<h3>Serializers</h3>
</div></div>
    
    <div id="footer">
  Generated on Sat Apr  9 13:43:32 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.7 (ruby-1.9.2).
</div>

  </body>
</html>